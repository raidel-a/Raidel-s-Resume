name: LaTex2PDF
# description: build LaTex manuscripts and push the latest PDF and PNG back to GitHub

on:
  push:
    branches: 
      - timestamped-version
    paths:
      - 'latexResume/resume.tex'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MANUSCRIPT_PATH: latexResume/resume
      LATEX: pdflatex
    steps:
    - uses: actions/checkout@v4.1.1
    
    - name: Install texlive
      run: |
            sudo apt-get install texlive-publishers \
                                 texlive-latex-recommended \
                                 texlive-latex-extra \
                                 texlive-fonts-recommended \
                                 texlive-fonts-extra
    
    - name: Build resume
      run: |
            cd ${MANUSCRIPT_PATH%/*}
            TIMESTAMP=$(date +%Y-%m-%d--%H-%M-%S)
            ${LATEX} ${MANUSCRIPT_PATH##*/}.tex
            cp ${MANUSCRIPT_PATH##*/}.pdf ${MANUSCRIPT_PATH##*/}_latest.pdf
            mv ${MANUSCRIPT_PATH##*/}.pdf ${MANUSCRIPT_PATH##*/}_$TIMESTAMP.pdf
            echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
                               
    - name: Push resume
      run: |
            cd ${MANUSCRIPT_PATH%/*}
            git add -f ${MANUSCRIPT_PATH##*/}_$TIMESTAMP.pdf
            git -c user.name='resume-maker' -c user.email='resume-maker' commit -m "update pdf"
            git push -q -f https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

    - name: Install ghostscript
      run: sudo apt-get update --fix-missing && sudo apt install ghostscript
    - name: Change ImageMagick security policy
      run: |
            DQT='"' 
            SRC="rights=${DQT}none${DQT} pattern=${DQT}PDF${DQT}"
            RPL="rights=${DQT}read\|write${DQT} pattern=${DQT}PDF${DQT}"
              
            HGT="name=${DQT}height${DQT} value=${DQT}10KP${DQT}"
            HGTR="name=${DQT}height${DQT} value=${DQT}128Kp${DQT}"
              
            WDT="name=${DQT}width${DQT} value=${DQT}10KP${DQT}"
            WDTR="name=${DQT}width${DQT} value=${DQT}128Kp${DQT}"
              
            MAP="name=${DQT}map${DQT} value=${DQT}512MiB${DQT}"
            MAPR="name=${DQT}map${DQT} value=${DQT}4GiB${DQT}"
              
            MEM="name=${DQT}memory${DQT} value=${DQT}256MiB${DQT}"
            MEMR="name=${DQT}memory${DQT} value=${DQT}2GiB${DQT}"
              
            sudo sed -i "s/$SRC/$RPL/" /etc/ImageMagick-6/policy.xml
            sudo sed -i "s/$HGT/$HGTR/" /etc/ImageMagick-6/policy.xml
            sudo sed -i "s/$WDT/$WDTR/" /etc/ImageMagick-6/policy.xml
            sudo sed -i "s/$MAP/$MAPR/" /etc/ImageMagick-6/policy.xml
            sudo sed -i "s/$MEM/$MEMR/" /etc/ImageMagick-6/policy.xml
              
    - name: Convert PDF to PNG
      run: |
            cd ${MANUSCRIPT_PATH%/*}
            convert -density 900 -background white -alpha off ${MANUSCRIPT_PATH##*/}_$TIMESTAMP.pdf -resize 25% -quality 90 -colorspace RGB ${MANUSCRIPT_PATH##*/}.png
    
    - name: Commit PNG
      id: commit
      run: |
            cd ${MANUSCRIPT_PATH%/*}
            git add -f ${MANUSCRIPT_PATH##*/}.png
            git -c user.name='resume-maker' -c user.email='resume-maker' commit -m "update png"
            git push -q -f https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
